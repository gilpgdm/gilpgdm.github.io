<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no">
    <script type="module" src="cmp/base.js"></script>
    <script type="module" src="cmp/mi-presentacion.js"></script>
    <link rel="stylesheet" href="css/estilos.css">
    <link rel="stylesheet" href="css/presentacion.css">
    <script type="module">
      import { SelDiapositivaBase } from "./lib/SelDiapositivaBase.js";
      customElements.define("mi-selector", class extends SelDiapositivaBase {
        /** @override
         * @returns {string} */
        get html() {
          return (/* html */
            `<select>
              <option value=intro>ESP8266</option>
              <option value=Blink>Blink.ino</option>
              <option value=Button>Button.ino</option>
              <option value=Descarga>Descarga de datos por WiFi</option>
              <option value=MiGet>MiGet.ino</option>
              <option value=Modifica>Modifica datos por WiFi</option>
              <option value=MiPatch>MiPatch.ino</option>
              <option value=Publica>Publica datos por WiFi</option>
              <option value=MiPost>MiPost.ino</option>
            </select>`);
        }
      });
    </script>
  </head>
  <body>
    <div class="cortina"></div>
    <mi-menu></mi-menu>
    <mi-presentacion class="desplaza">
      <mi-selector slot=selector></mi-selector>
      <div id=intro slot=diapositiva>
        <div class="cortina"></div>
        <header></header>
        <h1></h1>
        <div class="marco-lectura">
          <p>
            <a href="https://youtu.be/0g7sazWXfEI" target="_blank">Video de
              Instalación de Arduino IDE + ESP8266 + Tu primer programa.</a>
          </p>
        </div>
      </div>
      <section id=Blink slot=diapositiva>
          <div class="cortina"></div>
          <header></header>
          <h2></h2>
          <table>
            <tr>
              <td class=nums data-total="24"></td>
              <td class=cod><div><div><span style="color: #008000;">/*&nbsp;Este&nbsp;programa&nbsp;es&nbsp;un&nbsp;derivado&nbsp;de&nbsp;ESP8266&nbsp;Blink&nbsp;by&nbsp;Simon&nbsp;Peter&nbsp;*/</span></div><div><span style="color: #008000;">/*&nbsp;Indica&nbsp;los&nbsp;pines&nbsp;que&nbsp;traen&nbsp;un&nbsp;LED&nbsp;cableado.&nbsp;&nbsp;*/</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">LED_INTEGRADO_2</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #098658;">2</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">LED_INTEGRADO_16</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #098658;">16</span></div><br><div><span style="color: #008000;">/**&nbsp;Función&nbsp;que&nbsp;se&nbsp;invoca&nbsp;una&nbsp;sola&nbsp;vez&nbsp;al&nbsp;inicio&nbsp;del&nbsp;programa.&nbsp;*/</span>&nbsp;</div><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">setup</span>()&nbsp;{</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Initializa&nbsp;el&nbsp;pin&nbsp;para&nbsp;LED_INTEGRADO_2&nbsp;como&nbsp;salida.</span></div><div>&nbsp;&nbsp;<span style="color: #795e26;">pinMode</span>(<span style="color: #0000ff;">LED_INTEGRADO_2</span>,&nbsp;OUTPUT);</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Initializa&nbsp;el&nbsp;pin&nbsp;para&nbsp;LED_INTEGRADO_16&nbsp;como&nbsp;salida.</span></div><div>&nbsp;&nbsp;<span style="color: #795e26;">pinMode</span>(<span style="color: #0000ff;">LED_INTEGRADO_16</span>,&nbsp;OUTPUT);</div><div>}</div><br><div><span style="color: #008000;">/**&nbsp;Función&nbsp;que&nbsp;se&nbsp;invoca&nbsp;repetidamente&nbsp;mientras&nbsp;el&nbsp;programa&nbsp;esté&nbsp;activo.&nbsp;*/</span>&nbsp;</div><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">loop</span>()&nbsp;{</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Enciende&nbsp;el&nbsp;LED&nbsp;(LOW&nbsp;es&nbsp;el&nbsp;nivel&nbsp;de&nbsp;voltaje).</span></div><div>&nbsp;&nbsp;<span style="color: #795e26;">digitalWrite</span>(<span style="color: #0000ff;">LED_INTEGRADO_2</span>,&nbsp;LOW);</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Apaga&nbsp;el&nbsp;LED&nbsp;haciendo&nbsp;que&nbsp;el&nbsp;nivel&nbsp;de&nbsp;voltaje&nbsp;sea&nbsp;HIGH.</span></div><div>&nbsp;&nbsp;<span style="color: #795e26;">digitalWrite</span>(<span style="color: #0000ff;">LED_INTEGRADO_16</span>,&nbsp;HIGH);</div><div>&nbsp;&nbsp;<span style="color: #795e26;">delay</span>(<span style="color: #098658;">1000</span>);<span style="color: #008000;">&nbsp;//&nbsp;Espera&nbsp;por&nbsp;1&nbsp;segundo.</span></div><div>&nbsp;&nbsp;<span style="color: #795e26;">digitalWrite</span>(<span style="color: #0000ff;">LED_INTEGRADO_2</span>,&nbsp;HIGH);</div><div>&nbsp;&nbsp;<span style="color: #795e26;">digitalWrite</span>(<span style="color: #0000ff;">LED_INTEGRADO_16</span>,&nbsp;LOW);</div><div>&nbsp;&nbsp;<span style="color: #795e26;">delay</span>(<span style="color: #098658;">1000</span>);</div><div>}</div></div></td>
            </tr>
          </table>
        </section>
      <section id=Button slot=diapositiva>
          <div class="cortina"></div>
          <header></header>
          <h2></h2>
          <table>
            <tr>
              <td class=nums data-total="27"></td>
              <td class=cod><div><div><span style="color: #008000;">/*&nbsp;Este&nbsp;es&nbsp;un&nbsp;derivado&nbsp;de&nbsp;Button&nbsp;por&nbsp;DojoDave&nbsp;y&nbsp;Tom&nbsp;Igoe&nbsp;*/</span></div><br><div><span style="color: #008000;">//&nbsp;Constantes&nbsp;(no&nbsp;cambian)&nbsp;para&nbsp;asignar&nbsp;los&nbsp;números&nbsp;de&nbsp;pines.</span></div><div><span style="color: #0000ff;">const</span>&nbsp;<span style="color: #0000ff;">int</span>&nbsp;<span style="color: #001080;">BOTON_FLASH</span>&nbsp;=&nbsp;<span style="color: #098658;">0</span>;<span style="color: #008000;">&nbsp;//&nbsp;Pin&nbsp;que&nbsp;trae&nbsp;cableado&nbsp;el&nbsp;botón&nbsp;flash.</span></div><div><span style="color: #0000ff;">const</span>&nbsp;<span style="color: #0000ff;">int</span>&nbsp;<span style="color: #001080;">LED_INTEGRADO_2</span>&nbsp;=&nbsp;&nbsp;<span style="color: #098658;">2</span>;<span style="color: #008000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Pin&nbsp;que&nbsp;trae&nbsp;cableado&nbsp;un&nbsp;LED.</span></div><br><div><span style="color: #008000;">//&nbsp;Variable&nbsp;para&nbsp;leer&nbsp;el&nbsp;estaado&nbsp;del&nbsp;botón.</span></div><div><span style="color: #0000ff;">int</span>&nbsp;<span style="color: #001080;">estadoDelBoton</span>&nbsp;=&nbsp;<span style="color: #098658;">0</span>;</div><br><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">setup</span>()&nbsp;{</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Initializa&nbsp;el&nbsp;pin&nbsp;para&nbsp;LED_INTEGRADO_2&nbsp;como&nbsp;salida.</span></div><div>&nbsp;&nbsp;<span style="color: #795e26;">pinMode</span>(<span style="color: #001080;">LED_INTEGRADO_2</span>,&nbsp;OUTPUT);</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Initializa&nbsp;el&nbsp;pin&nbsp;para&nbsp;BOTÓN_FLASH&nbsp;como&nbsp;entrada.</span></div><div>&nbsp;&nbsp;<span style="color: #795e26;">pinMode</span>(<span style="color: #001080;">BOTON_FLASH</span>,&nbsp;INPUT);</div><div>}</div><br><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">loop</span>()&nbsp;{</div><div>&nbsp;&nbsp;<span style="color: #001080;">estadoDelBoton</span>&nbsp;=&nbsp;<span style="color: #795e26;">digitalRead</span>(<span style="color: #001080;">BOTON_FLASH</span>);</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Checa&nbsp;si&nbsp;el&nbsp;botón&nbsp;está&nbsp;presionado.&nbsp;Esto&nbsp;es,&nbsp;si&nbsp;estadoDelBotón&nbsp;es&nbsp;LOW:</span></div><div>&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">estadoDelBoton</span>&nbsp;==&nbsp;LOW)&nbsp;{</div><div><span style="color: #008000;">&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Enciende&nbsp;el&nbsp;LED.</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">digitalWrite</span>(<span style="color: #001080;">LED_INTEGRADO_2</span>,&nbsp;LOW);</div><div>&nbsp;&nbsp;}&nbsp;<span style="color: #af00db;">else</span>&nbsp;{</div><div><span style="color: #008000;">&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Apaga&nbsp;el&nbsp;LED.</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">digitalWrite</span>(<span style="color: #001080;">LED_INTEGRADO_2</span>,&nbsp;HIGH);</div><div>&nbsp;&nbsp;}</div><div>}</div></div></td>
            </tr>
          </table>
        </section>
        <section id=Descarga slot=diapositiva>
          <div class="cortina"></div>
          <header></header>
          <h2></h2>
          <div class="marco-lectura">
            <p>El código se muestra en la diapositiva siguiente (MiGet.ino).</p>
            <p>
              Necesitas instalar la librería ArduinoJSON usando el menú
              <strong>Herramientas &gt; Administrar
                Bibliotecas&hellip;</strong>.
            </p>
            <p>
              Este proyecto descarga una estructura JSON de tu base de datos
              Firestore para IoT, que es generada automáticamente por el
              servicio REST de Firestore.
            </p>
            <p>La estructura descargada es similar a esta:</p>
            <table>
            <tr>
              <td class=nums data-total="10"></td>
              <td class=cod><div><div>{</div><div>&nbsp;&nbsp;<span style="color: #0451a5;">"name"</span>:&nbsp;<span style="color: #a31515;">"projects/*******/databases/(default)/documents/SALIDA/iot2"</span>,</div><div>&nbsp;&nbsp;<span style="color: #0451a5;">"fields"</span>:&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"VALOR"</span>:&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"integerValue"</span>:&nbsp;<span style="color: #a31515;">"8"</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;},</div><div>&nbsp;&nbsp;<span style="color: #0451a5;">"createTime"</span>:&nbsp;<span style="color: #a31515;">"2020-10-10T03:10:21.432047Z"</span>,</div><div>&nbsp;&nbsp;<span style="color: #0451a5;">"updateTime"</span>:&nbsp;<span style="color: #a31515;">"2020-10-11T07:25:53.876468Z"</span></div><div>}</div></div></td>
            </tr>
          </table>
            <p>
              Para obtener el código de arduino que procesa JSON, usa el
              <a href="https://arduinojson.org/v6/assistant/"
                target="_blank">ArduinoJSON Assistant</a>
              y el fragmento de JSON del párrafo anterior.
            </p>
          </div>
        </section>
      <section id=MiGet slot=diapositiva>
          <div class="cortina"></div>
          <header></header>
          <h2></h2>
          <div class="marco-lectura">
            <p>
              En el siguiente código, sustituye los asteriscos por los datos de
              tu red WiFi, en la URL por el nombre de tu proyecto de Firebase y finalmente la huella digital del servidor REST de Firebase. 
            </p>
            <p>
              Usa las siguientes instrucciones para obtener la huella digital:
            </p>
            <ol>
              <li>
                <p>Usa Google Chrome para abrir la URL del código.</p>
              </li>
              <li>
                <p>
                  Haz clic en el candadito que está junto a la URL. Se abre un
                  menú contextual.
                </p>
              </li>
              <li>
                <p>
                  Haz clic en donde dice <q>Certificado (válido)</q>. Aparece
                  un cuadro de diálogo. Observa hasta cuando puedes usar esta
                  información. Despues de la fecha indicada, debes actualizar tu
                  código.
                </p>
              </li>
              <li>
                <p>
                  Selecciona la pestaña <q>Detalles</q>. Haz scroll hasta que
                  aparezca la <q>Huella digital</q>. Haz clic en esta propiedad
                  y abajo se muestra su valor. Copia y pega este valor a tu
                  código.
                </p>
              </li>
            </ol>
            <p>
              Para monitorear su funcionamiento, debes hacer clic en el botón de
              arriba a la derecha en la ventana de Arduino, que tiene una lupa y
              tiene el mensaje flotante que dice <strong>Monitor Serie</strong>.
              Debes ajustar los baudios a la misma velocidad que en el código,
              donde dice
              <code class="language-cpp">Serial.begin(115200);</code>
              que en este caso es 115200 baudios. Si no se ven los mensajes,
              baja la velocidad tanto en el código, como en el monitor.
            </p>
          </div>
          <table>
            <tr>
              <td class=nums data-total="73"></td>
              <td class=cod><div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266WiFi.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266WiFiMulti.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266HTTPClient.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;WiFiClientSecureBearSSL.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ArduinoJson.h&gt;</span></div><br><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">SSID</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"****"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">PASS</span><span style="color: #0000ff;">&nbsp;&nbsp;</span><span style="color: #a31515;">"****************"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">HOST</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"https://firestore.googleapis.com/v1/projects/********/databases/(default)/documents/SALIDA/iot2"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">HUELLA_DIGITAL</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"****************************"</span></div><br><div>ESP8266WiFiMulti&nbsp;<span style="color: #001080;">WiFiMulti</span>;</div><br><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">setup</span>()&nbsp;{</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Inicializa&nbsp;el&nbsp;monitor&nbsp;serial&nbsp;y&nbsp;calibra&nbsp;su&nbsp;velocidad.</span></div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">begin</span>(<span style="color: #098658;">115200</span>);</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Monitoreo&nbsp;detallado&nbsp;en&nbsp;la&nbsp;salida&nbsp;para&nbsp;encontrar&nbsp;errores.</span></div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Serial.setDebugOutput(true);</span></div><br><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><br><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Espera&nbsp;a&nbsp;que&nbsp;el&nbsp;hardware&nbsp;para&nbsp;WiFi&nbsp;esté&nbsp;listo.</span></div><div>&nbsp;&nbsp;<span style="color: #af00db;">for</span>&nbsp;(<span style="color: #0000ff;">uint8_t</span>&nbsp;<span style="color: #001080;">t</span>&nbsp;=&nbsp;<span style="color: #098658;">4</span>;&nbsp;<span style="color: #001080;">t</span>&nbsp;&gt;&nbsp;<span style="color: #098658;">0</span>;&nbsp;<span style="color: #001080;">t</span>--)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"[SETUP]&nbsp;ESPERANDO&nbsp;%d...</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,&nbsp;<span style="color: #001080;">t</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">flush</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">delay</span>(<span style="color: #098658;">1000</span>);</div><div>&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Conectando&nbsp;a&nbsp;WiFi..."</span>);</div><div>&nbsp;&nbsp;<span style="color: #001080;">WiFi</span>.<span style="color: #795e26;">mode</span>(WIFI_STA);</div><div>&nbsp;&nbsp;<span style="color: #001080;">WiFiMulti</span>.<span style="color: #795e26;">addAP</span>(<span style="color: #0000ff;">SSID</span>,&nbsp;<span style="color: #0000ff;">PASS</span>);</div><div>}</div><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">loop</span>()&nbsp;{</div><div>&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;((<span style="color: #001080;">WiFiMulti</span>.<span style="color: #795e26;">run</span>()&nbsp;==&nbsp;WL_CONNECTED))&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"WiFi&nbsp;conectado."</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #267f99;">std</span>::unique_ptr&lt;<span style="color: #267f99;">BearSSL</span>::WiFiClientSecure&gt;<span style="color: #795e26;">client</span>(</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">new</span>&nbsp;<span style="color: #267f99;">BearSSL</span>::WiFiClientSecure);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">client</span>-&gt;<span style="color: #795e26;">setFingerprint</span>(<span style="color: #0000ff;">HUELLA_DIGITAL</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<span style="color: #001080;">https</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">useHTTP10</span>(<span style="color: #0000ff;">true</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Conectando&nbsp;al&nbsp;servidor..."</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">https</span>.<span style="color: #795e26;">begin</span>(*client,&nbsp;<span style="color: #0000ff;">HOST</span>))&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Inicia&nbsp;GET..."</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff;">int</span>&nbsp;<span style="color: #001080;">codigoHttps</span>&nbsp;=&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">GET</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">codigoHttps</span>&nbsp;&gt;&nbsp;<span style="color: #098658;">0</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"Get&nbsp;OK.&nbsp;codigoHttps:&nbsp;%d</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,&nbsp;<span style="color: #001080;">codigoHttps</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">codigoHttps</span>&nbsp;==&nbsp;HTTP_CODE_NOT_FOUND)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"No&nbsp;encontrado"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #af00db;">else</span>&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">codigoHttps</span>&nbsp;==&nbsp;HTTP_CODE_OK</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;<span style="color: #001080;">codigoHttps</span>&nbsp;==&nbsp;HTTP_CODE_MOVED_PERMANENTLY)&nbsp;{</div><div><span style="color: #008000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Este&nbsp;valor&nbsp;debe&nbsp;obtenerse&nbsp;con&nbsp;ArduinoJson&nbsp;Assistant</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff;">const</span>&nbsp;<span style="color: #267f99;">size_t</span>&nbsp;<span style="color: #001080;">capacity</span>&nbsp;=</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #098658;">2</span>&nbsp;*&nbsp;<span style="color: #795e26;">JSON_OBJECT_SIZE</span>(<span style="color: #098658;">1</span>)&nbsp;+&nbsp;<span style="color: #795e26;">JSON_OBJECT_SIZE</span>(<span style="color: #098658;">4</span>)&nbsp;+&nbsp;<span style="color: #098658;">200</span>;</div><div><span style="color: #008000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Crea&nbsp;la&nbsp;estructura&nbsp;de&nbsp;dator&nbsp;para&nbsp;procesar&nbsp;JSON.</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DynamicJsonDocument&nbsp;<span style="color: #001080;">doc</span>(<span style="color: #001080;">capacity</span>);</div><div><span style="color: #008000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;A&nbsp;partir&nbsp;del&nbsp;texto&nbsp;devuelto&nbsp;por&nbsp;Internet,&nbsp;se&nbsp;obtiene&nbsp;el&nbsp;árbol&nbsp;JSON.</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">deserializeJson</span>(<span style="color: #001080;">doc</span>,&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">getStream</span>());</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff;">const</span>&nbsp;<span style="color: #0000ff;">int</span>&nbsp;<span style="color: #001080;">valor</span>&nbsp;=&nbsp;<span style="color: #001080;">doc</span>[<span style="color: #a31515;">"fields"</span>][<span style="color: #a31515;">"VALOR"</span>][<span style="color: #a31515;">"integerValue"</span>].<span style="color: #001080;">as</span>&lt;<span style="color: #0000ff;">int</span>&gt;();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"VALOR:&nbsp;%d</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,&nbsp;<span style="color: #001080;">valor</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #af00db;">else</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"GET&nbsp;falló.&nbsp;Error:&nbsp;%s</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">errorToString</span>(<span style="color: #001080;">codigoHttps</span>).<span style="color: #795e26;">c_str</span>());</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">end</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #af00db;">else</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"La&nbsp;conexión&nbsp;falló"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Esperando&nbsp;2s..."</span>);</div><div>&nbsp;&nbsp;<span style="color: #795e26;">delay</span>(<span style="color: #098658;">2000</span>);</div><div>}</div></div></td>
            </tr>
          </table>
        </section>
        <section id=Modifica slot=diapositiva>
          <div class="cortina"></div>
          <header></header>
          <h2></h2>
          <div class="marco-lectura">
            <p>
              El código se muestra en la diapositiva siguiente (MiPatch.ino).
            </p>
            <p>
              Necesitas instalar la librería ArduinoJSON como en el ejemplo
              anterior.
            </p>
            <p>
              Este proyecto sube una estructura JSON a tu base de datos
              Firestore para IoT, que es similar a esta:</p>
            <table>
            <tr>
              <td class=nums data-total="7"></td>
              <td class=cod><div><div>{</div><div>&nbsp;&nbsp;<span style="color: #0451a5;">"fields"</span>:&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"VALOR"</span>:&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"integerValue"</span>:&nbsp;<span style="color: #098658;">8</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;}</div><div>}</div></div></td>
            </tr>
          </table>
            <p>
              Para obtener el código de arduino que procesa JSON, usa el
              <a href="https://arduinojson.org/v6/assistant/"
                target="_blank">ArduinoJSON Assistant</a>
              y el fragmento de JSON del párrafo anterior.
            </p>
          </div>
        </section>
      <section id=MiPatch slot=diapositiva>
          <div class="cortina"></div>
          <header></header>
          <h2></h2>
          <div class="marco-lectura">
            <p>
              Debes adecuar el código de forma similar al ejercicio anterior y
              puedes usar la misma huella digital.
            </p>
          </div>
          <table>
            <tr>
              <td class=nums data-total="75"></td>
              <td class=cod><div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266WiFi.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266WiFiMulti.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266HTTPClient.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;WiFiClientSecureBearSSL.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ArduinoJson.h&gt;</span></div><br><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">SSID</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"****"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">PASS</span><span style="color: #0000ff;">&nbsp;&nbsp;</span><span style="color: #a31515;">"*************"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">HOST</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"https://firestore.googleapis.com/v1/projects/******/databases/(default)/documents/ENTRADA/iot2"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">HUELLA_DIGITAL</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"******************************"</span></div><br><div>ESP8266WiFiMulti&nbsp;<span style="color: #001080;">WiFiMulti</span>;</div><div><span style="color: #0000ff;">bool</span>&nbsp;<span style="color: #001080;">enviado</span>&nbsp;=&nbsp;<span style="color: #0000ff;">false</span>;</div><br><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">setup</span>()&nbsp;{</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">begin</span>(<span style="color: #098658;">115200</span>);</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Serial.setDebugOutput(true);</span></div><br><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><br><div>&nbsp;&nbsp;<span style="color: #af00db;">for</span>&nbsp;(<span style="color: #0000ff;">uint8_t</span>&nbsp;<span style="color: #001080;">t</span>&nbsp;=&nbsp;<span style="color: #098658;">4</span>;&nbsp;<span style="color: #001080;">t</span>&nbsp;&gt;&nbsp;<span style="color: #098658;">0</span>;&nbsp;<span style="color: #001080;">t</span>--)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"[SETUP]&nbsp;ESPERANDO&nbsp;%d...</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,&nbsp;<span style="color: #001080;">t</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">flush</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">delay</span>(<span style="color: #098658;">1000</span>);</div><div>&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Conectando&nbsp;a&nbsp;WiFi..."</span>);</div><div>&nbsp;&nbsp;<span style="color: #001080;">WiFi</span>.<span style="color: #795e26;">mode</span>(WIFI_STA);</div><div>&nbsp;&nbsp;<span style="color: #001080;">WiFiMulti</span>.<span style="color: #795e26;">addAP</span>(<span style="color: #0000ff;">SSID</span>,&nbsp;<span style="color: #0000ff;">PASS</span>);</div><div>}</div><br><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">loop</span>()&nbsp;{</div><div>&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;((<span style="color: #001080;">WiFiMulti</span>.<span style="color: #795e26;">run</span>()&nbsp;==&nbsp;WL_CONNECTED)&nbsp;&amp;&amp;&nbsp;!<span style="color: #001080;">enviado</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"WiFi&nbsp;conectado."</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #267f99;">std</span>::unique_ptr&lt;<span style="color: #267f99;">BearSSL</span>::WiFiClientSecure&gt;<span style="color: #795e26;">client</span>(</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">new</span>&nbsp;<span style="color: #267f99;">BearSSL</span>::WiFiClientSecure);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">client</span>-&gt;<span style="color: #795e26;">setFingerprint</span>(<span style="color: #0000ff;">HUELLA_DIGITAL</span>);</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff;">const</span>&nbsp;<span style="color: #267f99;">size_t</span>&nbsp;<span style="color: #001080;">capacity</span>&nbsp;=&nbsp;<span style="color: #098658;">3</span>&nbsp;*&nbsp;<span style="color: #795e26;">JSON_OBJECT_SIZE</span>(<span style="color: #098658;">1</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;DynamicJsonDocument&nbsp;<span style="color: #001080;">doc</span>(<span style="color: #001080;">capacity</span>);</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;JsonObject&nbsp;<span style="color: #001080;">fields</span>&nbsp;=&nbsp;<span style="color: #001080;">doc</span>.<span style="color: #795e26;">createNestedObject</span>(<span style="color: #a31515;">"fields"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;JsonObject&nbsp;<span style="color: #001080;">fields_VALOR</span>&nbsp;=&nbsp;<span style="color: #001080;">fields</span>.<span style="color: #795e26;">createNestedObject</span>(<span style="color: #a31515;">"VALOR"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">fields_VALOR</span>[<span style="color: #a31515;">"integerValue"</span>]&nbsp;=&nbsp;<span style="color: #098658;">8</span>;</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;<span style="color: #001080;">json</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">serializeJson</span>(<span style="color: #001080;">doc</span>,&nbsp;<span style="color: #001080;">json</span>);</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<span style="color: #001080;">https</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Conectando&nbsp;al&nbsp;servidor..."</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">https</span>.<span style="color: #795e26;">begin</span>(*client,&nbsp;<span style="color: #0000ff;">HOST</span>))&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">addHeader</span>(<span style="color: #a31515;">"Content-Type"</span>,&nbsp;<span style="color: #a31515;">"application/json"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">print</span>(<span style="color: #a31515;">"Inicia&nbsp;PATCH...</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff;">int</span>&nbsp;<span style="color: #001080;">codigoHttps</span>&nbsp;=&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">PATCH</span>(<span style="color: #001080;">json</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">codigoHttps</span>&nbsp;&gt;&nbsp;<span style="color: #098658;">0</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"PATCH&nbsp;OK.&nbsp;httpcode:&nbsp;%d</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,&nbsp;<span style="color: #001080;">codigoHttps</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;<span style="color: #001080;">texto</span>&nbsp;=&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">getString</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #001080;">texto</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">codigoHttps</span>&nbsp;==&nbsp;HTTP_CODE_OK</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;<span style="color: #001080;">codigoHttps</span>&nbsp;==&nbsp;HTTP_CODE_MOVED_PERMANENTLY)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">enviado</span>&nbsp;=&nbsp;<span style="color: #0000ff;">true</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #af00db;">else</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"PATCH&nbsp;falló.&nbsp;Error:&nbsp;%s</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">errorToString</span>(<span style="color: #001080;">codigoHttps</span>).<span style="color: #795e26;">c_str</span>());</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">end</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #af00db;">else</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"La&nbsp;conexión&nbsp;falló"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Esperando&nbsp;10s..."</span>);</div><div>&nbsp;&nbsp;<span style="color: #795e26;">delay</span>(<span style="color: #098658;">10000</span>);</div><div>}</div></div></td>
            </tr>
          </table>
        </section>
        <section id=Publica slot=diapositiva>
          <div class="cortina"></div>
          <header></header>
          <h2></h2>
          <div class="marco-lectura">
            <p>
              El código se muestra en la diapositiva siguiente (MiPost.ino).
            </p>
            <p>
              Necesitas instalar
              <a href="https://www.pjrc.com/teensy/td_download.html"
                target="_blank">Teensyduino</a>
              pues contiene la librería Time.
            </p>
            <p>
              Necesitas instalar las librerías ArduinoJSON, NTPClient y Time.
            </p>
            <p>
              Al publicar los datos se incluye una marca de tiempo (timestamp)
              que indica la fecha y hora en que el regstro se sube al servidor.
              Para ello, se usa la infraestructura mundial NTP para obtener
              fecha y hora.
            </p>
            <p>
              Este proyecto sube una estructura JSON a tu base de datos
              Firestore para IoT, que es similar a esta:</p>
            <table>
            <tr>
              <td class=nums data-total="13"></td>
              <td class=cod><div><div>{</div><div>&nbsp;&nbsp;<span style="color: #0451a5;">"fields"</span>:&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"HIST_TS"</span>:&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"timestampValue"</span>:&nbsp;<span style="color: #a31515;">"2020-10-12T04:28:22Z"</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;},</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"DISP_ID"</span>:&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"stringValue"</span>:&nbsp;<span style="color: #a31515;">"iot2"</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;},</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"VALOR"</span>:&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0451a5;">"integerValue"</span>:&nbsp;<span style="color: #a31515;">"0"</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;}</div><div>}</div></div></td>
            </tr>
          </table>
            <p>
              Para obtener el código de arduino que procesa JSON, usa el
              <a href="https://arduinojson.org/v6/assistant/"
                target="_blank">ArduinoJSON Assistant</a>
              y el fragmento de JSON del párrafo anterior.
            </p>
          </div>
        </section>
      <section id=MiPost slot=diapositiva>
          <div class="cortina"></div>
          <header></header>
          <h2></h2>
          <div class="marco-lectura">
            <p>
              Debes adecuar el código de forma similar al ejercicio anterior y
              puedes usar la misma huella digital.
            </p>
            <p>
              Como el procesamiento JSON incluye una cadena con el timestamp,
              hay que agregar el espacio ocupado por el buffer, al cálculo
              obtenido por el ArduinoJson Assistant.
            </p>
          </div>
          <table>
            <tr>
              <td class=nums data-total="98"></td>
              <td class=cod><div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266WiFi.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266WiFiMulti.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ESP8266HTTPClient.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;WiFiClientSecureBearSSL.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;ArduinoJson.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;TimeLib.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;NTPClient.h&gt;</span></div><div><span style="color: #af00db;">#include</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">&lt;WiFiUdp.h&gt;</span></div><br><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">SSID</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"****"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">PASS</span><span style="color: #0000ff;">&nbsp;&nbsp;</span><span style="color: #a31515;">"*****************"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">HOST</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"https://firestore.googleapis.com/v1/projects/*******/databases/(default)/documents/HISTORIAL"</span></div><div><span style="color: #af00db;">#define</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #0000ff;">HUELLA_DIGITAL</span><span style="color: #0000ff;">&nbsp;</span><span style="color: #a31515;">"****************************"</span></div><br><div>ESP8266WiFiMulti&nbsp;<span style="color: #001080;">WiFiMulti</span>;</div><div>WiFiUDP&nbsp;<span style="color: #001080;">ntpUDP</span>;</div><div><span style="color: #267f99;">NTPClient</span>&nbsp;<span style="color: #001080;">timeClient</span>(<span style="color: #267f99;">ntpUDP</span>);</div><br><div><span style="color: #0000ff;">bool</span>&nbsp;<span style="color: #001080;">enviado</span>&nbsp;=&nbsp;<span style="color: #0000ff;">false</span>;</div><br><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">setup</span>()&nbsp;{</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">begin</span>(<span style="color: #098658;">115200</span>);</div><div><span style="color: #008000;">&nbsp;&nbsp;//&nbsp;Serial.setDebugOutput(true);</span></div><br><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>();</div><br><div>&nbsp;&nbsp;<span style="color: #af00db;">for</span>&nbsp;(<span style="color: #0000ff;">uint8_t</span>&nbsp;<span style="color: #001080;">t</span>&nbsp;=&nbsp;<span style="color: #098658;">4</span>;&nbsp;<span style="color: #001080;">t</span>&nbsp;&gt;&nbsp;<span style="color: #098658;">0</span>;&nbsp;<span style="color: #001080;">t</span>--)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"[SETUP]&nbsp;ESPERANDO&nbsp;%d...</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,&nbsp;<span style="color: #001080;">t</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">flush</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">delay</span>(<span style="color: #098658;">1000</span>);</div><div>&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">print</span>(<span style="color: #a31515;">"Conectando&nbsp;a&nbsp;WiFi..."</span>);</div><div>&nbsp;&nbsp;<span style="color: #001080;">WiFi</span>.<span style="color: #795e26;">mode</span>(WIFI_STA);</div><div>&nbsp;&nbsp;<span style="color: #001080;">WiFiMulti</span>.<span style="color: #795e26;">addAP</span>(<span style="color: #0000ff;">SSID</span>,&nbsp;<span style="color: #0000ff;">PASS</span>);</div><div>&nbsp;&nbsp;<span style="color: #af00db;">while</span>&nbsp;((<span style="color: #001080;">WiFiMulti</span>.<span style="color: #795e26;">run</span>()&nbsp;!=&nbsp;WL_CONNECTED))&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">delay</span>&nbsp;(&nbsp;<span style="color: #098658;">500</span>&nbsp;);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">print</span>&nbsp;(&nbsp;<span style="color: #a31515;">"."</span>&nbsp;);</div><div>&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"WiFi&nbsp;connectado."</span>);</div><div>&nbsp;&nbsp;<span style="color: #001080;">timeClient</span>.<span style="color: #795e26;">begin</span>();</div><div>&nbsp;&nbsp;<span style="color: #795e26;">delay</span>&nbsp;(&nbsp;<span style="color: #098658;">500</span>&nbsp;);</div><div>}</div><div><span style="color: #0000ff;">void</span>&nbsp;<span style="color: #795e26;">loop</span>()&nbsp;{</div><div>&nbsp;&nbsp;<span style="color: #001080;">timeClient</span>.<span style="color: #795e26;">update</span>();</div><div>&nbsp;&nbsp;<span style="color: #0000ff;">unsigned</span>&nbsp;<span style="color: #0000ff;">long</span>&nbsp;<span style="color: #001080;">t</span>&nbsp;=&nbsp;<span style="color: #001080;">timeClient</span>.<span style="color: #795e26;">getEpochTime</span>();</div><div>&nbsp;&nbsp;<span style="color: #0000ff;">char</span>&nbsp;<span style="color: #001080;">ts</span>[<span style="color: #098658;">30</span>];</div><div>&nbsp;&nbsp;<span style="color: #795e26;">sprintf</span>(<span style="color: #001080;">ts</span>,&nbsp;<span style="color: #a31515;">"%02d-%02d-%02dT%02d:%02d:%02d.00Z"</span>,&nbsp;<span style="color: #795e26;">year</span>(<span style="color: #001080;">t</span>),&nbsp;<span style="color: #795e26;">month</span>(<span style="color: #001080;">t</span>),&nbsp;<span style="color: #795e26;">day</span>(<span style="color: #001080;">t</span>),</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">hour</span>(<span style="color: #001080;">t</span>),&nbsp;<span style="color: #795e26;">minute</span>(<span style="color: #001080;">t</span>),&nbsp;<span style="color: #795e26;">second</span>(<span style="color: #001080;">t</span>));</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #001080;">ts</span>);</div><div>&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;((<span style="color: #001080;">WiFiMulti</span>.<span style="color: #795e26;">run</span>()&nbsp;==&nbsp;WL_CONNECTED)&nbsp;&amp;&amp;&nbsp;!<span style="color: #001080;">enviado</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #267f99;">std</span>::unique_ptr&lt;<span style="color: #267f99;">BearSSL</span>::WiFiClientSecure&gt;<span style="color: #795e26;">client</span>(</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">new</span>&nbsp;<span style="color: #267f99;">BearSSL</span>::WiFiClientSecure);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">client</span>-&gt;<span style="color: #795e26;">setFingerprint</span>(<span style="color: #0000ff;">HUELLA_DIGITAL</span>);</div><br><div><span style="color: #008000;">&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Al&nbsp;cálculo&nbsp;del&nbsp;tamaño&nbsp;le&nbsp;añadimos&nbsp;30,&nbsp;que&nbsp;es&nbsp;el&nbsp;tamaño&nbsp;del&nbsp;buffer&nbsp;para</span></div><div><span style="color: #008000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;el&nbsp;timestap.&nbsp;*/</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff;">const</span>&nbsp;<span style="color: #267f99;">size_t</span>&nbsp;<span style="color: #001080;">capacity</span>&nbsp;=&nbsp;<span style="color: #098658;">4</span>&nbsp;*&nbsp;<span style="color: #795e26;">JSON_OBJECT_SIZE</span>(<span style="color: #098658;">1</span>)&nbsp;+&nbsp;<span style="color: #795e26;">JSON_OBJECT_SIZE</span>(<span style="color: #098658;">3</span>)&nbsp;+&nbsp;<span style="color: #098658;">30</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;DynamicJsonDocument&nbsp;<span style="color: #001080;">doc</span>(<span style="color: #001080;">capacity</span>);</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;JsonObject&nbsp;<span style="color: #001080;">fields</span>&nbsp;=&nbsp;<span style="color: #001080;">doc</span>.<span style="color: #795e26;">createNestedObject</span>(<span style="color: #a31515;">"fields"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;JsonObject&nbsp;<span style="color: #001080;">fields_DISP_ID</span>&nbsp;=&nbsp;<span style="color: #001080;">fields</span>.<span style="color: #795e26;">createNestedObject</span>(<span style="color: #a31515;">"DISP_ID"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">fields_DISP_ID</span>[<span style="color: #a31515;">"stringValue"</span>]&nbsp;=&nbsp;<span style="color: #a31515;">"iot2"</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;JsonObject&nbsp;<span style="color: #001080;">fields_VALOR</span>&nbsp;=&nbsp;<span style="color: #001080;">fields</span>.<span style="color: #795e26;">createNestedObject</span>(<span style="color: #a31515;">"VALOR"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">fields_VALOR</span>[<span style="color: #a31515;">"integerValue"</span>]&nbsp;=&nbsp;<span style="color: #098658;">0</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;JsonObject&nbsp;<span style="color: #001080;">fields_HIST_TS</span>&nbsp;=&nbsp;<span style="color: #001080;">fields</span>.<span style="color: #795e26;">createNestedObject</span>(<span style="color: #a31515;">"HIST_TS"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">fields_HIST_TS</span>[<span style="color: #a31515;">"timestampValue"</span>]&nbsp;=&nbsp;<span style="color: #001080;">ts</span>;</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;<span style="color: #001080;">json</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #795e26;">serializeJson</span>(<span style="color: #001080;">doc</span>,&nbsp;<span style="color: #001080;">json</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #001080;">json</span>.<span style="color: #795e26;">c_str</span>());</div><div>&nbsp;&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<span style="color: #001080;">https</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Conectando&nbsp;al&nbsp;servidor..."</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">https</span>.<span style="color: #795e26;">begin</span>(*client,&nbsp;<span style="color: #0000ff;">HOST</span>))&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">addHeader</span>(<span style="color: #a31515;">"Content-Type"</span>,&nbsp;<span style="color: #a31515;">"application/json"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">print</span>(<span style="color: #a31515;">"Inicia&nbsp;POST...</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff;">int</span>&nbsp;<span style="color: #001080;">codigoHttps</span>&nbsp;=&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">POST</span>(<span style="color: #001080;">json</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">codigoHttps</span>&nbsp;&gt;&nbsp;<span style="color: #098658;">0</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"POST&nbsp;OK.&nbsp;httpcode:&nbsp;%d</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,&nbsp;<span style="color: #001080;">codigoHttps</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;<span style="color: #001080;">texto</span>&nbsp;=&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">getString</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #001080;">texto</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">codigoHttps</span>&nbsp;==&nbsp;HTTP_CODE_OK</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;<span style="color: #001080;">codigoHttps</span>&nbsp;==&nbsp;HTTP_CODE_MOVED_PERMANENTLY)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">enviado</span>&nbsp;=&nbsp;<span style="color: #0000ff;">true</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #af00db;">else</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">printf</span>(<span style="color: #a31515;">"POST&nbsp;falló.&nbsp;Error:&nbsp;%s</span><span style="color: #ee0000;">\n</span><span style="color: #a31515;">"</span>,</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">errorToString</span>(<span style="color: #001080;">codigoHttps</span>).<span style="color: #795e26;">c_str</span>());</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">https</span>.<span style="color: #795e26;">end</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #af00db;">else</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"La&nbsp;conexión&nbsp;falló"</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;<span style="color: #001080;">Serial</span>.<span style="color: #795e26;">println</span>(<span style="color: #a31515;">"Esperando&nbsp;10s..."</span>);</div><div>&nbsp;&nbsp;<span style="color: #795e26;">delay</span>(<span style="color: #098658;">10000</span>);</div><div>}</div></div></td>
            </tr>
          </table>
        </section>
    </mi-presentacion>
  </body>
  <script type="module" src="lib/comun.js"></script>
</html>